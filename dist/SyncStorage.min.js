/*! SyncStorage 16-03-2014 */
define([],function(){var a=function(){};return a.prototype.nextNumber=function(a,b){if(a||(a=0),b||(b=1),a>b)throw"min > max !";return Math.random()*(b-a)+a},a.prototype.nextInt=function(a,b){return Math.floor(this.nextNumber(a,b+1))},a.prototype.alphaDic="0987654321POIUYTREZAMLKJHGFDSQNBVCXWpoiuytrezamlkjhgfdsqnbvcxw",a.prototype.nextAlpha=function(a){a||(a=1);for(var b="",c=0;a>c;c++)b+=this.alphaDic.charAt(this.nextInt(0,this.alphaDic.length-1));return b},a}),define(["utils/StringUtils","underscore","q","db/StoragePlus","basicStorage/InMemoryStorage","Random"],function(a,b,c,d,e,f){var g=function(b,c){var f=this;this.name=b,this.isLocal=!a.startsWith(b,"http"),c||(c=new e),this.storage=new d(b,c),this.storageVersion=new d("version$$"+b,c),this.onConflict=function(a,b){console.error("Conflict detected on "+f.name+". This method should be overriden. doc1 and doc2 in conflicts :"),console.error(a),console.error(b)}};g.prototype.random=new f;var h=function(a){var b=a.split("-");return{version:b[0],hash:b[1]}},i=function(a){if(!a._id)throw JSON.stringify(a)+" should have an _id field";var b=a._id;return a._rev&&(b+="/"+a._rev),b},j=function(a,b){var d=h(b._rev),e=d.version;return a.get({_id:b._id}).then(function(f){var g=[],j=!f;if(!j){var k=h(f._rev);if(j=k.version<e||k.version===e&&k.hash<d.hash,k.version>=e){var l=a.onConflict(f,b);if(l){var m=function(b){b._timstamp=(new Date).getTime(),delete b._synced,delete b._conflict,a.storageVersion.save(i(b),b)};console.log("conflict solved with onConflict function : "+JSON.stringify(l)),m(f),m(b),g.push(a.save(l))}else{var n=j?f:b;n._conflict=!0;var o={_id:n._id,_rev:n._rev};console.warn(JSON.stringify(o)+" marked as conflicted on "+a.name),n==f&&(f._timestamp=(new Date).getTime(),delete f._synced,a.storageVersion.save(i(f),f))}}}return a.storageVersion.save(i(b),b),j&&(console.log("store object on "+a.name+" : "+JSON.stringify(b)),g.push(a.storage.save(b._id,b))),c.all(g).then(function(){return b})})};g.prototype.save=function(a){var c=this,d=b.extend({},a),e=(new Date).getTime();d._id||(d._id=e+c.random.nextAlpha(10));var f=1;if(d._rev){var f=h(d._rev).version;f++}return d._rev=f+"-"+c.random.nextAlpha(30),d._timestamp=e,delete d._synced,delete d._conflict,j(c,d)},g.prototype.get=function(a){var b=a._rev?this.storageVersion:this.storage;return b.get(i(a)).then(function(a){return a?(delete a._synced,a):a})},g.prototype.del=function(a){var b=a._rev?this.storageVersion:this.storage;return b.del(i(a))},g.prototype.query=function(a){return console.log("query="+JSON.stringify(a)),this.storage.query(a).then(function(a){return console.log("result query="+JSON.stringify(a)),a})},g.prototype.queryHistory=function(a){return console.log("query history="+JSON.stringify(a)),this.storageVersion.query(a).then(function(a){return console.log("result query history="+JSON.stringify(a)),a})};var k=function(a,d){var e,f="$repTo$"+d.name;return a.storage.get(f).then(function(b){var c=b?b._timestamp:void 0;return e=(new Date).getTime(),console.log("start replicating from "+a.name+" to "+d.name+". startTimestamp="+c+", endTimestamp="+e),a.storageVersion.query({mapFunction:function(a,b){b._synced||a(b._timestamp,b)},startkey:c,endkey:e,indexDef:"_timestamp"})}).then(function(a){if(0===a.total_rows)return 0;var e=[];for(var f in a.rows)b.each(a.rows[f],function(a){var b=a;b._synced=!0,e.push(j(d,b))});return c.all(e).then(function(a){return a.length})}).then(function(a){var b={ok:!0,size:a};return b}).then(function(b){return a.storage.save(f,{_timestamp:e}).then(function(){return console.log("rep "+a.name+" to "+d.name+" ended : "+JSON.stringify(b)),b})}).fail(function(b){return console.log("rep "+a.name+" to "+d.name+" ended : "+JSON.stringify(b)),{error:!0,message:"Something went bad when updating objects"}})};return g.prototype.syncWith=function(a){var b=this;return k(b,a).then(function(c){return k(a,b).then(function(a){return{to:c,from:a}})})},g.prototype.waitIndex=function(){return this.storage.waitIndex()},g.prototype.destroy=function(){var a=this;return c.all([a.storage.destroy(),a.storageVersion.destroy()])},g}),define(["SyncStorage","basicStorage/LocalForageBridge","basicStorage/FacadeStorage","utils/FunctionUtils","localForage","q"],function(a,b,c,d,e,f){return function(){d.onCondition(function(){return e.driver?!0:!1},function(){for(var b=new a("test",new c),d=(new Date).getTime(),e=[],g=0;5>g;g++){var h=b.save({value:"plop"});e.push(h)}f.all(e).then(function(){var a=(new Date).getTime();b.waitIndex().then(function(){return b.query({mapFunction:function(a,b){a(b._timestamp,b)},startkey:d+"",endkey:a+"",indexDef:"_timestamp"})}).then(function(b){var c=(new Date).getTime();console.log("elapsed time = "+(c-a)),console.log(b)}).then(function(){})})})}}),define(["q","underscore","basicStorage/IndexedDbStorage","basicStorage/LocalStorageBridge"],function(a,b,c,d){var e=[d,c],f=b.find(e,function(a){return a.isSupported&&a.isSupported()});if(!f)throw"no impl is supported for FacadeStorage";var g=function(){this.storage=new f};return g.prototype.save=function(a,b){return this.storage.save(a,b)},g.prototype.get=function(a){return this.storage.get(a)},g.prototype.del=function(a){return this.storage.del(a)},g.prototype.destroy=function(){return this.storage.destroy()},g}),define(["q","underscore"],function(a,b){var c=function(){};return c.prototype.save=function(b,c){var d=a.defer();return this[b]=JSON.stringify(c),d.resolve(c),d.promise},c.prototype.get=function(b){var c=a.defer(),d=this[b],e=d?JSON.parse(d):null;return c.resolve(e),c.promise},c.prototype.del=function(b){var c=a.defer(),d=this[b]?!0:!1;return delete this[b],c.resolve(d),c.promise},c.prototype.destroy=function(){var c=a.defer();return b.each(this,function(a,b){console.log("delete "+b),delete this[b]}),c.resolve(),c.promise},c}),define(["q"],function(a){var b=function(){if(!b.isSupported())throw"IndexedDB is not supported by your browser";d(this)},c=function(a,b){a.onsuccess=function(a){b.resolve(a.target.result)},a.onerror=function(a){b.reject(a)}};b.prototype.save=function(a,b){var d=this,f=e(d),g=f.put(b);return c(g,defer),defer.promise},b.prototype.get=function(b){var d=a.defer(),f=e(this).index("_id"),g=f.get(b);return c(g,d),d.promise},b.prototype.del=function(b){var d=a.defer(),f=e(this).delete(b);return c(f,d),d.promise},b.prototype.destroy=function(){var b=this,c=a.defer(),e=this.indexedDB.deleteDatabase("indexedDbStorage");return e.onsuccess=function(){c.resolve(),d(b)},e.onerror=function(a){c.reject(a)},c.promise};var d=function(b){b.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,b.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,b.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange;var c=a.defer(),d=b.indexedDB.open("indexedDbStorage",1);return d.onsuccess=function(){b.db=d.result,c.resolve(d.result)},d.onerror=function(a){c.reject(a)},d.onupgradeneeded=function(a){var b=a.target.result,c=b.createObjectStore("data",{keyPath:"_id"});c.createIndex("_rev","_rev",{unique:!1}),c.createIndex("_id","_id",{unique:!0})},c.promise},e=function(a){return a.db.transaction(["data"],"readwrite").objectStore("data")};return b.isSupported=function(){var a=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;return a?!0:!1},b}),define(["localForage","q"],function(a,b){var c=function(){};return c.prototype.save=function(c,d){var e=b.defer();return a.setItem(c,JSON.stringify(d)),e.resolve(d),e.promise},c.prototype.get=function(c){var d=b.defer(),e=a.getItem(c),f=e?JSON.parse(e):null;return d.resolve(f),d.promise},c.prototype.del=function(a){var c=b.defer();return c.resolve(this.save(a,void 0)),c.promise},c.prototype.destroy=function(){throw"not supported"},c}),define(["q","underscore"],function(a){var b=function(){};return b.prototype.save=function(b,c){var d=a.defer();return localStorage.setItem(b,JSON.stringify(c)),d.resolve(c),d.promise},b.prototype.get=function(b){var c=a.defer(),d=localStorage.getItem(b),e=d?JSON.parse(d):null;return c.resolve(e),c.promise},b.prototype.del=function(b){var c=a.defer();return localStorage.removeItem(b),c.resolve(),c.promise},b.prototype.destroy=function(){var b=a.defer();return localStorage.clear(),b.resolve(),b.promise},b.isSupported=function(){return!0},b}),define(["q","underscore","utils/FunctionUtils"],function(a,b,c){var d=function(a){this.storage=a,g(this)},e=function(){var b=a.defer();return b.resolve(),b.promise},f=function(a){return 0==b.size(a.buffer)?e():a.getAll().then(function(d){return 0==b.size(a.buffer)?e():void c.onCondition(function(){var b=!1;return a.lock||(a.lock=!0,b=!0),b},function(){var b=d;b||(b={}),console.log("adding buffer...");for(var c in a.buffer){var e=a.buffer[c];b[c]=e}return a.buffer={},a.storage.save("_all",b).then(function(){a.lock=!1})})}).then(function(){return f(a)})};d.prototype.addIndexKey=function(a,b){return this.buffer[a]=b,f(this)},d.prototype.getAll=function(){return this.storage.get("_all").then(function(a){return a?a:{}})},d.prototype.waitIndex=function(){return f(this)};var g=function(a){a.buffer={},a.lock=!1};return d.prototype.destroy=function(){var a=this;return this.storage.del("_all").then(function(){g(a)})},d}),define(["q","utils/StringUtils","db/IndexStorage","underscore"],function(a,b,c,d){var e=function(a,b,d){this.name=a,this.storage=b,d||(this.indexStorage=new c(new e("__index__"+a,this.storage,!0)))},f=function(a){return a.name+"/"},g=function(a,b){return f(a)+b};return e.prototype.save=function(a,b){var c=g(this,a);return this.indexStorage&&this.indexStorage.addIndexKey(a,b),this.storage.save(c,b)},e.prototype.get=function(a){return this.storage.get(g(this,a))},e.prototype.del=function(a){return this.storage.del(g(this,a))},e.prototype.query=function(b){if(!this.indexStorage)throw"not supported : this is an index storage";if(!b.mapFunction)throw"mapFunction must be defined in the query";if(!b.indexDef)throw"indexDef must be defined in the query";var c=this,e={},f=0,g=0,h=function(a,c){if(!(b.startkey&&a<b.startkey||b.endkey&&a>b.endkey)){var h=e[a];h||(h=[],e[a]=h,g++),h.push(d.extend({},c)),f++}};return this.indexStorage.getAll().then(function(i){var j=d.map(i,function(a,d){return c.get(d).then(function(a){a&&b.mapFunction(h,a)})});return a.all(j).then(function(){return{total_keys:g,total_rows:f,rows:e}})})},e.prototype.getAll=function(){return this.query({mapFunction:function(a,b){a(b._id,b)},indexDef:"_id"})},e.prototype.waitIndex=function(){if(this.indexStorage)return this.indexStorage.waitIndex();var b=a.defer();return b.resolve(),b.promise},e.prototype.destroy=function(){if(!this.indexStorage){var b=a.defer();return b.resolve(),b.promise}var c=this;return c.waitIndex().then(function(){return c.indexStorage.getAll()}).then(function(b){return console.log("result="),console.log(b),a.all(d.map(b,function(a,b){return console.log("deleting "+b),c.del(b)}))}).then(function(){return c.indexStorage?c.indexStorage.destroy():!0})},e}),require.config({baseUrl:"js",paths:{PouchDB:"../../lib/PouchDb/PouchDb",q:"../../lib/q/q",underscore:"../../lib/underscore/underscore",localForage:"../../lib/localForage/localForage.min"},shim:{underscore:{exports:"_"}}}),require(["app"],function(a){a()}),define(["utils/ObjectUtils","utils/Utils"],function(a,b){var c=function(a,b,c,d){this.key=a,this.oldValue=b,this.newValue=c,this.type=d};return c.CREATE="CREATE",c.UPDATE="UPDATE",c.DELETE="DELETE",c.prototype.apply=function(a){var d=this.type;if(d==c.UPDATE){if(!b.equalsGeneric(a[this.key],this.oldValue))throw"Impossible to apply "+JSON.stringify(this)+" on "+JSON.stringify(a)+". oldValue is "+JSON.stringify(a[this.key])+" and should be "+JSON.stringify(this.oldValue);a[this.key]=this.newValue}else if(d==c.CREATE){if(void 0!==a[this.key])throw"Impossible to apply "+JSON.stringify(this)+" on "+JSON.stringify(a)+". key "+this.key+" already exists with value "+JSON.stringify(a[this.key]);a[this.key]=this.newValue}else{if(d!=c.DELETE)throw"unknown type of change : "+d;if(void 0===a[this.key])throw"Impossible to apply "+JSON.stringify(this)+" on "+JSON.stringify(a)+". key "+this.key+" has no value : "+a[this.key];delete a[this.key]}return a},c.prototype.revert=function(a){var b=this.type;if(b==c.UPDATE||b==c.DELETE)a[this.key]=this.oldValue;else{if(b!=c.CREATE)throw"unknown type of change : "+b;delete a[this.key]}return a},c.prototype.applyToArray=function(a){var b=this.type;if(b==c.CREATE)a.push(this.newValue);else{if(b!=c.DELETE)throw"unknown type of change : "+b;a.removeByValue(this.oldValue)}return a},c.prototype.revertFromArray=function(a){var b=this.type;if(b==c.CREATE)a.removeByValue(this.newValue);else{if(b!=c.DELETE)throw"unknown type of change : "+b;a.push(this.oldValue)}return a},c}),define(["utils/ObjectUtils","synchronize/Change","utils/ArrayUtils"],function(a,b){var c=function(){this.equalsFunction=function(a,b){return a===b},this.isNotDefinedFunction=function(a){return void 0===a}};return c.prototype.synchronize=function(a,c){var d=new Array,e=new Array,f=this;return a.pourChaque(function(a,g){e.push(g);var h,i=c[g];f.isNotDefinedFunction(a)?h=new b(g,a,i,b.CREATE):f.isNotDefinedFunction(i)?h=new b(g,a,i,b.DELETE):f.equalsFunction(a,i)||(h=new b(g,a,i,b.UPDATE)),void 0!==h&&d.push(h)}),c.pourChaque(function(a,c){e.containsValue(c)||d.push(new b(c,void 0,a,b.CREATE))}),d},c.prototype.synchronizeSet=function(a,c){var d=(new Array).concat(c),e=[],f=this;a.pourChaque(function(a){var c=d.pourChaque(function(b,c){return f.equalsFunction(a,b)?(d.removeByIndex(c),1):void 0});void 0===c&&e.push(new b(void 0,a,void 0,b.DELETE))});var g=d.transform(function(a){return new b(void 0,void 0,a,b.CREATE)});return g.concat(e)},c}),define(["utils/ObjectUtils"],function(){console.log("loading array utils");var a=function(){},b=function(a,b,c){a.prototype[b]=c};return b(Array,"transform",function(a){var b=new Array;return this.pourChaque(function(c,d){b[d]=a(c,d)}),b}),b(Array,"removeByIndex",function(a){if(0>a||a>=this.length)throw"index out of bounds : "+a+" out of 0 -> "+(this.length-1);return this.splice(a,1),this}),b(Array,"removeByValue",function(a){var b=this.findFirstMatching(function(b){return a===b?!0:"object"!=typeof a?!1:a.equals(b)});if(void 0==b)throw JSON.stringify(a)+" not found";return this.removeByIndex(b[0])}),b(Array,"removeAll",function(a){var b=this;return a.pourChaque(function(a){var c=b.keyOfValue(a);c!==!1&&b.removeByIndex(c)}),this}),b(Array,"containsAll",function(a){var b=this.clone(),c=a.pourChaque(function(a){var c=b.keyOfValue(a);return c===!1?!1:void b.removeByIndex(c)});return void 0!==c?c:!0}),b(Array,"equalsContains",function(a){return a.length!=this.length?!1:this.containsAll(a)}),new a}),define([],function(){var a=function(){};return a.prototype.onCondition=function(b,c){b()?c():setTimeout(function(){a.prototype.onCondition(b,c)},50)},a.prototype.cron=function(a,b){var c=this;setTimeout(function(){c.cron(a,b),b()},a)},new a}),define([],function(){function a(a,b,c){if(void 0!==a.prototype[b])throw"function "+b+" already defined on "+a;a.prototype[b]=c}var b=function(){};a(b,"addFunction",a),a(b,"override",function(a,b,c){if(void 0===a.prototype[b])throw b+" is not defined on "+a;a.prototype[b]=c});var c=function(a,b){return function(){throw"Abstract method '"+a+"' on class "+b.constructor+" : Not implemented !"}};return a(b,"addAbstractMethod",function(a,b){var c=function(a,b){return function(){throw"Abstract method '"+a+"' on class "+b.constructor+" : Not implemented !"}};a.prototype[b]=c(b,a)}),a(b,"implement",function(a,b,d){if(a.prototype[b]+""!=c(b,a)+"")throw b+" on "+a+" is not an abstract method. This is : "+a.prototype[b];a.prototype[b]=d}),a(b,"extend",function(a,b){a.prototype=new b}),b.prototype.instanceOf=function(a,b){for(;null!=a;){if(a==b.prototype)return!0;a=a.__proto__}return!1},new b}),define([],function(){var a=function(){};return a.prototype.startsWith=function(a,b){return a.substring(0,b.length)==b},new a}),define([],function(){var a=function(){};return a.prototype.assertException=function(a){try{a(),expect(a+"").toBe("throwing exception")}catch(b){console.log("exception expected has come : "+b)}},a.prototype.expectEquals=function(a,b){var c=a.equals(b);c||expect(a).toBe("equals to "+JSON.stringify(b))},a.prototype.expectNotEquals=function(a,b){var c=a.equals(b);c&&expect(a).toBe(" not to be equals to "+JSON.stringify(b))},a.prototype.expectEqualsSet=function(a,b){var c=a.equalsContains(b);c||expect(a).toBe("equals unorderly to "+JSON.stringify(b))},new a}),define(["utils/ObjectUtils"],function(a){console.log("loading utils");var b=function(){},c=a.addFunction;c(b,"forEach",function(a,b){for(var c in a){var d=a[c];if("function"!=typeof d){var e=b(d,c);if(void 0!==e)return e}}}),c(Object,"pourChaque",function(a){return b.prototype.forEach(this,a)}),c(Object,"size",function(){var a=0;return this.pourChaque(function(){a++}),a});var d=function(a,b){return void 0==a||void 0==b?a===b:"object"==typeof a?a.equals(b):"object"==typeof b?b.equals(a):b===a};return c(b,"equalsGeneric",d),c(Object,"equals",function(a){if("object"!=typeof a)return!1;var b=0,c=this.pourChaque(function(c,e){return d(c,a[e])?void b++:!1});return void 0!=c?c:b==a.size()}),c(Object,"keyOfValue",function(a){var b=this.pourChaque(function(b,c){return d(b,a)?c:void 0});return void 0!==b?b:!1}),c(Object,"containsValue",function(a){return this.keyOfValue(a)!==!1}),c(Object,"asString",function(a,b){void 0==a&&(a=","),void 0==b&&(b=function(a){return a+""});var c="";return this.pourChaque(function(d,e){c+=a+b(d,e)}),c.substring(a.length)}),c(Object,"transform",function(a){var b=new Object;return this.pourChaque(function(c,d){b[d]=a(c,d)}),b}),c(Object,"filter",function(a){var b=new Object;return this.pourChaque(function(c,d){a(c,d)&&(b[d]=c)}),b}),c(Object,"findFirstMatching",function(a){return this.pourChaque(function(b,c){return a(b,c)?new Array(c,b):void 0})}),c(Object,"clone",function(){var a=new this.constructor;return this.pourChaque(function(b,c){a[c]=b}),a}),new b});