//     Underscore.js 1.6.0
//     http://underscorejs.org
//     (c) 2009-2014 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
//     Underscore may be freely distributed under the MIT license.

/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */

define("utils/StringUtils",[],function(){var e=function(){};return e.prototype.startsWith=function(e,t){return e.substring(0,t.length)==t},new e}),function(){var e=this,t=e._,n={},r=Array.prototype,i=Object.prototype,s=Function.prototype,o=r.push,u=r.slice,a=r.concat,f=i.toString,l=i.hasOwnProperty,c=r.forEach,h=r.map,p=r.reduce,d=r.reduceRight,v=r.filter,m=r.every,g=r.some,y=r.indexOf,b=r.lastIndexOf,w=Array.isArray,E=Object.keys,S=s.bind,x=function(e){if(e instanceof x)return e;if(!(this instanceof x))return new x(e);this._wrapped=e};typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=x),exports._=x):e._=x,x.VERSION="1.6.0";var T=x.each=x.forEach=function(e,t,r){if(e==null)return e;if(c&&e.forEach===c)e.forEach(t,r);else if(e.length===+e.length){for(var i=0,s=e.length;i<s;i++)if(t.call(r,e[i],i,e)===n)return}else{var o=x.keys(e);for(var i=0,s=o.length;i<s;i++)if(t.call(r,e[o[i]],o[i],e)===n)return}return e};x.map=x.collect=function(e,t,n){var r=[];return e==null?r:h&&e.map===h?e.map(t,n):(T(e,function(e,i,s){r.push(t.call(n,e,i,s))}),r)};var N="Reduce of empty array with no initial value";x.reduce=x.foldl=x.inject=function(e,t,n,r){var i=arguments.length>2;e==null&&(e=[]);if(p&&e.reduce===p)return r&&(t=x.bind(t,r)),i?e.reduce(t,n):e.reduce(t);T(e,function(e,s,o){i?n=t.call(r,n,e,s,o):(n=e,i=!0)});if(!i)throw new TypeError(N);return n},x.reduceRight=x.foldr=function(e,t,n,r){var i=arguments.length>2;e==null&&(e=[]);if(d&&e.reduceRight===d)return r&&(t=x.bind(t,r)),i?e.reduceRight(t,n):e.reduceRight(t);var s=e.length;if(s!==+s){var o=x.keys(e);s=o.length}T(e,function(u,a,f){a=o?o[--s]:--s,i?n=t.call(r,n,e[a],a,f):(n=e[a],i=!0)});if(!i)throw new TypeError(N);return n},x.find=x.detect=function(e,t,n){var r;return C(e,function(e,i,s){if(t.call(n,e,i,s))return r=e,!0}),r},x.filter=x.select=function(e,t,n){var r=[];return e==null?r:v&&e.filter===v?e.filter(t,n):(T(e,function(e,i,s){t.call(n,e,i,s)&&r.push(e)}),r)},x.reject=function(e,t,n){return x.filter(e,function(e,r,i){return!t.call(n,e,r,i)},n)},x.every=x.all=function(e,t,r){t||(t=x.identity);var i=!0;return e==null?i:m&&e.every===m?e.every(t,r):(T(e,function(e,s,o){if(!(i=i&&t.call(r,e,s,o)))return n}),!!i)};var C=x.some=x.any=function(e,t,r){t||(t=x.identity);var i=!1;return e==null?i:g&&e.some===g?e.some(t,r):(T(e,function(e,s,o){if(i||(i=t.call(r,e,s,o)))return n}),!!i)};x.contains=x.include=function(e,t){return e==null?!1:y&&e.indexOf===y?e.indexOf(t)!=-1:C(e,function(e){return e===t})},x.invoke=function(e,t){var n=u.call(arguments,2),r=x.isFunction(t);return x.map(e,function(e){return(r?t:e[t]).apply(e,n)})},x.pluck=function(e,t){return x.map(e,x.property(t))},x.where=function(e,t){return x.filter(e,x.matches(t))},x.findWhere=function(e,t){return x.find(e,x.matches(t))},x.max=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.max.apply(Math,e);var r=-Infinity,i=-Infinity;return T(e,function(e,s,o){var u=t?t.call(n,e,s,o):e;u>i&&(r=e,i=u)}),r},x.min=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.min.apply(Math,e);var r=Infinity,i=Infinity;return T(e,function(e,s,o){var u=t?t.call(n,e,s,o):e;u<i&&(r=e,i=u)}),r},x.shuffle=function(e){var t,n=0,r=[];return T(e,function(e){t=x.random(n++),r[n-1]=r[t],r[t]=e}),r},x.sample=function(e,t,n){return t==null||n?(e.length!==+e.length&&(e=x.values(e)),e[x.random(e.length-1)]):x.shuffle(e).slice(0,Math.max(0,t))};var k=function(e){return e==null?x.identity:x.isFunction(e)?e:x.property(e)};x.sortBy=function(e,t,n){return t=k(t),x.pluck(x.map(e,function(e,r,i){return{value:e,index:r,criteria:t.call(n,e,r,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;if(n!==r){if(n>r||n===void 0)return 1;if(n<r||r===void 0)return-1}return e.index-t.index}),"value")};var L=function(e){return function(t,n,r){var i={};return n=k(n),T(t,function(s,o){var u=n.call(r,s,o,t);e(i,u,s)}),i}};x.groupBy=L(function(e,t,n){x.has(e,t)?e[t].push(n):e[t]=[n]}),x.indexBy=L(function(e,t,n){e[t]=n}),x.countBy=L(function(e,t){x.has(e,t)?e[t]++:e[t]=1}),x.sortedIndex=function(e,t,n,r){n=k(n);var i=n.call(r,t),s=0,o=e.length;while(s<o){var u=s+o>>>1;n.call(r,e[u])<i?s=u+1:o=u}return s},x.toArray=function(e){return e?x.isArray(e)?u.call(e):e.length===+e.length?x.map(e,x.identity):x.values(e):[]},x.size=function(e){return e==null?0:e.length===+e.length?e.length:x.keys(e).length},x.first=x.head=x.take=function(e,t,n){return e==null?void 0:t==null||n?e[0]:t<0?[]:u.call(e,0,t)},x.initial=function(e,t,n){return u.call(e,0,e.length-(t==null||n?1:t))},x.last=function(e,t,n){return e==null?void 0:t==null||n?e[e.length-1]:u.call(e,Math.max(e.length-t,0))},x.rest=x.tail=x.drop=function(e,t,n){return u.call(e,t==null||n?1:t)},x.compact=function(e){return x.filter(e,x.identity)};var A=function(e,t,n){return t&&x.every(e,x.isArray)?a.apply(n,e):(T(e,function(e){x.isArray(e)||x.isArguments(e)?t?o.apply(n,e):A(e,t,n):n.push(e)}),n)};x.flatten=function(e,t){return A(e,t,[])},x.without=function(e){return x.difference(e,u.call(arguments,1))},x.partition=function(e,t){var n=[],r=[];return T(e,function(e){(t(e)?n:r).push(e)}),[n,r]},x.uniq=x.unique=function(e,t,n,r){x.isFunction(t)&&(r=n,n=t,t=!1);var i=n?x.map(e,n,r):e,s=[],o=[];return T(i,function(n,r){if(t?!r||o[o.length-1]!==n:!x.contains(o,n))o.push(n),s.push(e[r])}),s},x.union=function(){return x.uniq(x.flatten(arguments,!0))},x.intersection=function(e){var t=u.call(arguments,1);return x.filter(x.uniq(e),function(e){return x.every(t,function(t){return x.contains(t,e)})})},x.difference=function(e){var t=a.apply(r,u.call(arguments,1));return x.filter(e,function(e){return!x.contains(t,e)})},x.zip=function(){var e=x.max(x.pluck(arguments,"length").concat(0)),t=new Array(e);for(var n=0;n<e;n++)t[n]=x.pluck(arguments,""+n);return t},x.object=function(e,t){if(e==null)return{};var n={};for(var r=0,i=e.length;r<i;r++)t?n[e[r]]=t[r]:n[e[r][0]]=e[r][1];return n},x.indexOf=function(e,t,n){if(e==null)return-1;var r=0,i=e.length;if(n){if(typeof n!="number")return r=x.sortedIndex(e,t),e[r]===t?r:-1;r=n<0?Math.max(0,i+n):n}if(y&&e.indexOf===y)return e.indexOf(t,n);for(;r<i;r++)if(e[r]===t)return r;return-1},x.lastIndexOf=function(e,t,n){if(e==null)return-1;var r=n!=null;if(b&&e.lastIndexOf===b)return r?e.lastIndexOf(t,n):e.lastIndexOf(t);var i=r?n:e.length;while(i--)if(e[i]===t)return i;return-1},x.range=function(e,t,n){arguments.length<=1&&(t=e||0,e=0),n=arguments[2]||1;var r=Math.max(Math.ceil((t-e)/n),0),i=0,s=new Array(r);while(i<r)s[i++]=e,e+=n;return s};var O=function(){};x.bind=function(e,t){var n,r;if(S&&e.bind===S)return S.apply(e,u.call(arguments,1));if(!x.isFunction(e))throw new TypeError;return n=u.call(arguments,2),r=function(){if(this instanceof r){O.prototype=e.prototype;var i=new O;O.prototype=null;var s=e.apply(i,n.concat(u.call(arguments)));return Object(s)===s?s:i}return e.apply(t,n.concat(u.call(arguments)))}},x.partial=function(e){var t=u.call(arguments,1);return function(){var n=0,r=t.slice();for(var i=0,s=r.length;i<s;i++)r[i]===x&&(r[i]=arguments[n++]);while(n<arguments.length)r.push(arguments[n++]);return e.apply(this,r)}},x.bindAll=function(e){var t=u.call(arguments,1);if(t.length===0)throw new Error("bindAll must be passed function names");return T(t,function(t){e[t]=x.bind(e[t],e)}),e},x.memoize=function(e,t){var n={};return t||(t=x.identity),function(){var r=t.apply(this,arguments);return x.has(n,r)?n[r]:n[r]=e.apply(this,arguments)}},x.delay=function(e,t){var n=u.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},x.defer=function(e){return x.delay.apply(x,[e,1].concat(u.call(arguments,1)))},x.throttle=function(e,t,n){var r,i,s,o=null,u=0;n||(n={});var a=function(){u=n.leading===!1?0:x.now(),o=null,s=e.apply(r,i),r=i=null};return function(){var f=x.now();!u&&n.leading===!1&&(u=f);var l=t-(f-u);return r=this,i=arguments,l<=0?(clearTimeout(o),o=null,u=f,s=e.apply(r,i),r=i=null):!o&&n.trailing!==!1&&(o=setTimeout(a,l)),s}},x.debounce=function(e,t,n){var r,i,s,o,u,a=function(){var f=x.now()-o;f<t?r=setTimeout(a,t-f):(r=null,n||(u=e.apply(s,i),s=i=null))};return function(){s=this,i=arguments,o=x.now();var f=n&&!r;return r||(r=setTimeout(a,t)),f&&(u=e.apply(s,i),s=i=null),u}},x.once=function(e){var t=!1,n;return function(){return t?n:(t=!0,n=e.apply(this,arguments),e=null,n)}},x.wrap=function(e,t){return x.partial(t,e)},x.compose=function(){var e=arguments;return function(){var t=arguments;for(var n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},x.after=function(e,t){return function(){if(--e<1)return t.apply(this,arguments)}},x.keys=function(e){if(!x.isObject(e))return[];if(E)return E(e);var t=[];for(var n in e)x.has(e,n)&&t.push(n);return t},x.values=function(e){var t=x.keys(e),n=t.length,r=new Array(n);for(var i=0;i<n;i++)r[i]=e[t[i]];return r},x.pairs=function(e){var t=x.keys(e),n=t.length,r=new Array(n);for(var i=0;i<n;i++)r[i]=[t[i],e[t[i]]];return r},x.invert=function(e){var t={},n=x.keys(e);for(var r=0,i=n.length;r<i;r++)t[e[n[r]]]=n[r];return t},x.functions=x.methods=function(e){var t=[];for(var n in e)x.isFunction(e[n])&&t.push(n);return t.sort()},x.extend=function(e){return T(u.call(arguments,1),function(t){if(t)for(var n in t)e[n]=t[n]}),e},x.pick=function(e){var t={},n=a.apply(r,u.call(arguments,1));return T(n,function(n){n in e&&(t[n]=e[n])}),t},x.omit=function(e){var t={},n=a.apply(r,u.call(arguments,1));for(var i in e)x.contains(n,i)||(t[i]=e[i]);return t},x.defaults=function(e){return T(u.call(arguments,1),function(t){if(t)for(var n in t)e[n]===void 0&&(e[n]=t[n])}),e},x.clone=function(e){return x.isObject(e)?x.isArray(e)?e.slice():x.extend({},e):e},x.tap=function(e,t){return t(e),e};var M=function(e,t,n,r){if(e===t)return e!==0||1/e==1/t;if(e==null||t==null)return e===t;e instanceof x&&(e=e._wrapped),t instanceof x&&(t=t._wrapped);var i=f.call(e);if(i!=f.call(t))return!1;switch(i){case"[object String]":return e==String(t);case"[object Number]":return e!=+e?t!=+t:e==0?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if(typeof e!="object"||typeof t!="object")return!1;var s=n.length;while(s--)if(n[s]==e)return r[s]==t;var o=e.constructor,u=t.constructor;if(o!==u&&!(x.isFunction(o)&&o instanceof o&&x.isFunction(u)&&u instanceof u)&&"constructor"in e&&"constructor"in t)return!1;n.push(e),r.push(t);var a=0,l=!0;if(i=="[object Array]"){a=e.length,l=a==t.length;if(l)while(a--)if(!(l=M(e[a],t[a],n,r)))break}else{for(var c in e)if(x.has(e,c)){a++;if(!(l=x.has(t,c)&&M(e[c],t[c],n,r)))break}if(l){for(c in t)if(x.has(t,c)&&!(a--))break;l=!a}}return n.pop(),r.pop(),l};x.isEqual=function(e,t){return M(e,t,[],[])},x.isEmpty=function(e){if(e==null)return!0;if(x.isArray(e)||x.isString(e))return e.length===0;for(var t in e)if(x.has(e,t))return!1;return!0},x.isElement=function(e){return!!e&&e.nodeType===1},x.isArray=w||function(e){return f.call(e)=="[object Array]"},x.isObject=function(e){return e===Object(e)},T(["Arguments","Function","String","Number","Date","RegExp"],function(e){x["is"+e]=function(t){return f.call(t)=="[object "+e+"]"}}),x.isArguments(arguments)||(x.isArguments=function(e){return!!e&&!!x.has(e,"callee")}),typeof /./!="function"&&(x.isFunction=function(e){return typeof e=="function"}),x.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},x.isNaN=function(e){return x.isNumber(e)&&e!=+e},x.isBoolean=function(e){return e===!0||e===!1||f.call(e)=="[object Boolean]"},x.isNull=function(e){return e===null},x.isUndefined=function(e){return e===void 0},x.has=function(e,t){return l.call(e,t)},x.noConflict=function(){return e._=t,this},x.identity=function(e){return e},x.constant=function(e){return function(){return e}},x.property=function(e){return function(t){return t[e]}},x.matches=function(e){return function(t){if(t===e)return!0;for(var n in e)if(e[n]!==t[n])return!1;return!0}},x.times=function(e,t,n){var r=Array(Math.max(0,e));for(var i=0;i<e;i++)r[i]=t.call(n,i);return r},x.random=function(e,t){return t==null&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))},x.now=Date.now||function(){return(new Date).getTime()};var _={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};_.unescape=x.invert(_.escape);var D={escape:new RegExp("["+x.keys(_.escape).join("")+"]","g"),unescape:new RegExp("("+x.keys(_.unescape).join("|")+")","g")};x.each(["escape","unescape"],function(e){x[e]=function(t){return t==null?"":(""+t).replace(D[e],function(t){return _[e][t]})}}),x.result=function(e,t){if(e==null)return void 0;var n=e[t];return x.isFunction(n)?n.call(e):n},x.mixin=function(e){T(x.functions(e),function(t){var n=x[t]=e[t];x.prototype[t]=function(){var e=[this._wrapped];return o.apply(e,arguments),F.call(this,n.apply(x,e))}})};var P=0;x.uniqueId=function(e){var t=++P+"";return e?e+t:t},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var H=/(.)^/,B={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},j=/\\|'|\r|\n|\t|\u2028|\u2029/g;x.template=function(e,t,n){var r;n=x.defaults({},n,x.templateSettings);var i=new RegExp([(n.escape||H).source,(n.interpolate||H).source,(n.evaluate||H).source].join("|")+"|$","g"),s=0,o="__p+='";e.replace(i,function(t,n,r,i,u){return o+=e.slice(s,u).replace(j,function(e){return"\\"+B[e]}),n&&(o+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),r&&(o+="'+\n((__t=("+r+"))==null?'':__t)+\n'"),i&&(o+="';\n"+i+"\n__p+='"),s=u+t.length,t}),o+="';\n",n.variable||(o="with(obj||{}){\n"+o+"}\n"),o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{r=new Function(n.variable||"obj","_",o)}catch(u){throw u.source=o,u}if(t)return r(t,x);var a=function(e){return r.call(this,e,x)};return a.source="function("+(n.variable||"obj")+"){\n"+o+"}",a},x.chain=function(e){return x(e).chain()};var F=function(e){return this._chain?x(e).chain():e};x.mixin(x),T(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=r[e];x.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),(e=="shift"||e=="splice")&&n.length===0&&delete n[0],F.call(this,n)}}),T(["concat","join","slice"],function(e){var t=r[e];x.prototype[e]=function(){return F.call(this,t.apply(this._wrapped,arguments))}}),x.extend(x.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),typeof define=="function"&&define.amd&&define("underscore",[],function(){return x})}.call(this),function(e){if(typeof bootstrap=="function")bootstrap("promise",e);else if(typeof exports=="object")module.exports=e();else if(typeof define=="function"&&define.amd)define("q",e);else if(typeof ses!="undefined"){if(!ses.ok())return;ses.makeQ=e}else Q=e()}(function(){function u(e){return function(){return o.apply(e,arguments)}}function m(e){return e===Object(e)}function g(e){return v(e)==="[object StopIteration]"||e instanceof y}function w(t,n){if(e&&n.stack&&typeof t=="object"&&t!==null&&t.stack&&t.stack.indexOf(b)===-1){var r=[];for(var i=n;!!i;i=i.source)i.stack&&r.unshift(i.stack);r.unshift(t.stack);var s=r.join("\n"+b+"\n");t.stack=E(s)}}function E(e){var t=e.split("\n"),n=[];for(var r=0;r<t.length;++r){var i=t[r];!T(i)&&!S(i)&&i&&n.push(i)}return n.join("\n")}function S(e){return e.indexOf("(module.js:")!==-1||e.indexOf("(node.js:")!==-1}function x(e){var t=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(e);if(t)return[t[1],Number(t[2])];var n=/at ([^ ]+):(\d+):(?:\d+)$/.exec(e);if(n)return[n[1],Number(n[2])];var r=/.*@(.+):(\d+)$/.exec(e);if(r)return[r[1],Number(r[2])]}function T(e){var t=x(e);if(!t)return!1;var i=t[0],s=t[1];return i===r&&s>=n&&s<=ot}function N(){if(!e)return;try{throw new Error}catch(t){var n=t.stack.split("\n"),i=n[0].indexOf("@")>0?n[1]:n[2],s=x(i);if(!s)return;return r=s[0],s[1]}}function C(e,t,n){return function(){return typeof console!="undefined"&&typeof console.warn=="function"&&console.warn(t+" is deprecated, use "+n+" instead.",(new Error("")).stack),e.apply(e,arguments)}}function k(e){return P(e)?e:H(e)?$(e):V(e)}function L(){function l(e){r=e,o.source=e,f(t,function(t,n){s(function(){e.promiseDispatch.apply(e,n)})},void 0),t=void 0,n=void 0}var t=[],n=[],r,i=h(L.prototype),o=h(M.prototype);o.promiseDispatch=function(e,i,o){var u=a(arguments);t?(t.push(u),i==="when"&&o[1]&&n.push(o[1])):s(function(){r.promiseDispatch.apply(r,u)})},o.valueOf=function(){if(t)return o;var e=D(r);return P(e)&&(r=e),e},o.inspect=function(){return r?r.inspect():{state:"pending"}};if(k.longStackSupport&&e)try{throw new Error}catch(u){o.stack=u.stack.substring(u.stack.indexOf("\n")+1)}return i.promise=o,i.resolve=function(e){if(r)return;l(k(e))},i.fulfill=function(e){if(r)return;l(V(e))},i.reject=function(e){if(r)return;l(X(e))},i.notify=function(e){if(r)return;f(n,function(t,n){s(function(){n(e)})},void 0)},i}function A(e){if(typeof e!="function")throw new TypeError("resolver must be a function.");var t=L();try{e(t.resolve,t.reject,t.notify)}catch(n){t.reject(n)}return t.promise}function O(e){return A(function(t,n){for(var r=0,i=e.length;r<i;r++)k(e[r]).then(t,n)})}function M(e,t,n){t===void 0&&(t=function(e){return X(new Error("Promise does not support operation: "+e))}),n===void 0&&(n=function(){return{state:"unknown"}});var r=h(M.prototype);r.promiseDispatch=function(n,i,s){var o;try{e[i]?o=e[i].apply(r,s):o=t.call(r,i,s)}catch(u){o=X(u)}n&&n(o)},r.inspect=n;if(n){var i=n();i.state==="rejected"&&(r.exception=i.reason),r.valueOf=function(){var e=n();return e.state==="pending"||e.state==="rejected"?r:e.value}}return r}function _(e,t,n,r){return k(e).then(t,n,r)}function D(e){if(P(e)){var t=e.inspect();if(t.state==="fulfilled")return t.value}return e}function P(e){return m(e)&&typeof e.promiseDispatch=="function"&&typeof e.inspect=="function"}function H(e){return m(e)&&typeof e.then=="function"}function B(e){return P(e)&&e.inspect().state==="pending"}function j(e){return!P(e)||e.inspect().state==="fulfilled"}function F(e){return P(e)&&e.inspect().state==="rejected"}function U(){I.length=0,q.length=0,R||(R=!0)}function z(e,t){if(!R)return;q.push(e),t&&typeof t.stack!="undefined"?I.push(t.stack):I.push("(no stack) "+t)}function W(e){if(!R)return;var t=l(q,e);t!==-1&&(q.splice(t,1),I.splice(t,1))}function X(e){var t=M({when:function(t){return t&&W(this),t?t(e):this}},function(){return this},function(){return{state:"rejected",reason:e}});return z(t,e),t}function V(e){return M({when:function(){return e},get:function(t){return e[t]},set:function(t,n){e[t]=n},"delete":function(t){delete e[t]},post:function(t,n){return t===null||t===void 0?e.apply(void 0,n):e[t].apply(e,n)},apply:function(t,n){return e.apply(t,n)},keys:function(){return d(e)}},void 0,function(){return{state:"fulfilled",value:e}})}function $(e){var t=L();return s(function(){try{e.then(t.resolve,t.reject,t.notify)}catch(n){t.reject(n)}}),t.promise}function J(e){return M({isDef:function(){}},function(n,r){return et(e,n,r)},function(){return k(e).inspect()})}function K(e,t,n){return k(e).spread(t,n)}function Q(e){return function(){function t(e,t){var s;if(typeof StopIteration=="undefined"){try{s=n[e](t)}catch(o){return X(o)}return s.done?s.value:_(s.value,r,i)}try{s=n[e](t)}catch(o){return g(o)?o.value:X(o)}return _(s,r,i)}var n=e.apply(this,arguments),r=t.bind(t,"next"),i=t.bind(t,"throw");return r()}}function G(e){k.done(k.async(e)())}function Y(e){throw new y(e)}function Z(e){return function(){return K([this,tt(arguments)],function(t,n){return e.apply(t,n)})}}function et(e,t,n){return k(e).dispatch(t,n)}function tt(e){return _(e,function(e){var t=0,n=L();return f(e,function(r,i,s){var o;P(i)&&(o=i.inspect()).state==="fulfilled"?e[s]=o.value:(++t,_(i,function(r){e[s]=r,--t===0&&n.resolve(e)},n.reject,function(e){n.notify({index:s,value:e})}))},void 0),t===0&&n.resolve(e),n.promise})}function nt(e){return _(e,function(e){return e=c(e,k),_(tt(c(e,function(e){return _(e,i,i)})),function(){return e})})}function rt(e){return k(e).allSettled()}function it(e,t){return k(e).then(void 0,void 0,t)}function st(e,t){return k(e).nodeify(t)}var e=!1;try{throw new Error}catch(t){e=!!t.stack}var n=N(),r,i=function(){},s=function(){function o(){while(e.next){e=e.next;var t=e.task;e.task=void 0;var r=e.domain;r&&(e.domain=void 0,r.enter());try{t()}catch(s){if(i)throw r&&r.exit(),setTimeout(o,0),r&&r.enter(),s;setTimeout(function(){throw s},0)}r&&r.exit()}n=!1}var e={task:void 0,next:null},t=e,n=!1,r=void 0,i=!1;s=function(e){t=t.next={task:e,domain:i&&process.domain,next:null},n||(n=!0,r())};if(typeof process!="undefined"&&process.nextTick)i=!0,r=function(){process.nextTick(o)};else if(typeof setImmediate=="function")typeof window!="undefined"?r=setImmediate.bind(window,o):r=function(){setImmediate(o)};else if(typeof MessageChannel!="undefined"){var u=new MessageChannel;u.port1.onmessage=function(){r=a,u.port1.onmessage=o,o()};var a=function(){u.port2.postMessage(0)};r=function(){setTimeout(o,0),a()}}else r=function(){setTimeout(o,0)};return s}(),o=Function.call,a=u(Array.prototype.slice),f=u(Array.prototype.reduce||function(e,t){var n=0,r=this.length;if(arguments.length===1)do{if(n in this){t=this[n++];break}if(++n>=r)throw new TypeError}while(1);for(;n<r;n++)n in this&&(t=e(t,this[n],n));return t}),l=u(Array.prototype.indexOf||function(e){for(var t=0;t<this.length;t++)if(this[t]===e)return t;return-1}),c=u(Array.prototype.map||function(e,t){var n=this,r=[];return f(n,function(i,s,o){r.push(e.call(t,s,o,n))},void 0),r}),h=Object.create||function(e){function t(){}return t.prototype=e,new t},p=u(Object.prototype.hasOwnProperty),d=Object.keys||function(e){var t=[];for(var n in e)p(e,n)&&t.push(n);return t},v=u(Object.prototype.toString),y;typeof ReturnValue!="undefined"?y=ReturnValue:y=function(e){this.value=e};var b="From previous event:";k.resolve=k,k.nextTick=s,k.longStackSupport=!1,k.defer=L,L.prototype.makeNodeResolver=function(){var e=this;return function(t,n){t?e.reject(t):arguments.length>2?e.resolve(a(arguments,1)):e.resolve(n)}},k.Promise=A,k.promise=A,A.race=O,A.all=tt,A.reject=X,A.resolve=k,k.passByCopy=function(e){return e},M.prototype.passByCopy=function(){return this},k.join=function(e,t){return k(e).join(t)},M.prototype.join=function(e){return k([this,e]).spread(function(e,t){if(e===t)return e;throw new Error("Can't join: not the same: "+e+" "+t)})},k.race=O,M.prototype.race=function(){return this.then(k.race)},k.makePromise=M,M.prototype.toString=function(){return"[object Promise]"},M.prototype.then=function(e,t,n){function u(t){try{return typeof e=="function"?e(t):t}catch(n){return X(n)}}function a(e){if(typeof t=="function"){w(e,r);try{return t(e)}catch(n){return X(n)}}return X(e)}function f(e){return typeof n=="function"?n(e):e}var r=this,i=L(),o=!1;return s(function(){r.promiseDispatch(function(e){if(o)return;o=!0,i.resolve(u(e))},"when",[function(e){if(o)return;o=!0,i.resolve(a(e))}])}),r.promiseDispatch(void 0,"when",[void 0,function(e){var t,n=!1;try{t=f(e)}catch(r){n=!0;if(!k.onerror)throw r;k.onerror(r)}n||i.notify(t)}]),i.promise},k.when=_,M.prototype.thenResolve=function(e){return this.then(function(){return e})},k.thenResolve=function(e,t){return k(e).thenResolve(t)},M.prototype.thenReject=function(e){return this.then(function(){throw e})},k.thenReject=function(e,t){return k(e).thenReject(t)},k.nearer=D,k.isPromise=P,k.isPromiseAlike=H,k.isPending=B,M.prototype.isPending=function(){return this.inspect().state==="pending"},k.isFulfilled=j,M.prototype.isFulfilled=function(){return this.inspect().state==="fulfilled"},k.isRejected=F,M.prototype.isRejected=function(){return this.inspect().state==="rejected"};var I=[],q=[],R=!0;k.resetUnhandledRejections=U,k.getUnhandledReasons=function(){return I.slice()},k.stopUnhandledRejectionTracking=function(){U(),R=!1},U(),k.reject=X,k.fulfill=V,k.master=J,k.spread=K,M.prototype.spread=function(e,t){return this.all().then(function(t){return e.apply(void 0,t)},t)},k.async=Q,k.spawn=G,k["return"]=Y,k.promised=Z,k.dispatch=et,M.prototype.dispatch=function(e,t){var n=this,r=L();return s(function(){n.promiseDispatch(r.resolve,e,t)}),r.promise},k.get=function(e,t){return k(e).dispatch("get",[t])},M.prototype.get=function(e){return this.dispatch("get",[e])},k.set=function(e,t,n){return k(e).dispatch("set",[t,n])},M.prototype.set=function(e,t){return this.dispatch("set",[e,t])},k.del=k["delete"]=function(e,t){return k(e).dispatch("delete",[t])},M.prototype.del=M.prototype["delete"]=function(e){return this.dispatch("delete",[e])},k.mapply=k.post=function(e,t,n){return k(e).dispatch("post",[t,n])},M.prototype.mapply=M.prototype.post=function(e,t){return this.dispatch("post",[e,t])},k.send=k.mcall=k.invoke=function(e,t){return k(e).dispatch("post",[t,a(arguments,2)])},M.prototype.send=M.prototype.mcall=M.prototype.invoke=function(e){return this.dispatch("post",[e,a(arguments,1)])},k.fapply=function(e,t){return k(e).dispatch("apply",[void 0,t])},M.prototype.fapply=function(e){return this.dispatch("apply",[void 0,e])},k["try"]=k.fcall=function(e){return k(e).dispatch("apply",[void 0,a(arguments,1)])},M.prototype.fcall=function(){return this.dispatch("apply",[void 0,a(arguments)])},k.fbind=function(e){var t=k(e),n=a(arguments,1);return function(){return t.dispatch("apply",[this,n.concat(a(arguments))])}},M.prototype.fbind=function(){var e=this,t=a(arguments);return function(){return e.dispatch("apply",[this,t.concat(a(arguments))])}},k.keys=function(e){return k(e).dispatch("keys",[])},M.prototype.keys=function(){return this.dispatch("keys",[])},k.all=tt,M.prototype.all=function(){return tt(this)},k.allResolved=C(nt,"allResolved","allSettled"),M.prototype.allResolved=function(){return nt(this)},k.allSettled=rt,M.prototype.allSettled=function(){return this.then(function(e){return tt(c(e,function(e){function t(){return e.inspect()}return e=k(e),e.then(t,t)}))})},k.fail=k["catch"]=function(e,t){return k(e).then(void 0,t)},M.prototype.fail=M.prototype["catch"]=function(e){return this.then(void 0,e)},k.progress=it,M.prototype.progress=function(e){return this.then(void 0,void 0,e)},k.fin=k["finally"]=function(e,t){return k(e)["finally"](t)},M.prototype.fin=M.prototype["finally"]=function(e){return e=k(e),this.then(function(t){return e.fcall().then(function(){return t})},function(t){return e.fcall().then(function(){throw t})})},k.done=function(e,t,n,r){return k(e).done(t,n,r)},M.prototype.done=function(e,t,n){var r=function(e){s(function(){w(e,i);if(!k.onerror)throw e;k.onerror(e)})},i=e||t||n?this.then(e,t,n):this;typeof process=="object"&&process&&process.domain&&(r=process.domain.bind(r)),i.then(void 0,r)},k.timeout=function(e,t,n){return k(e).timeout(t,n)},M.prototype.timeout=function(e,t){var n=L(),r=setTimeout(function(){n.reject(new Error(t||"Timed out after "+e+" ms"))},e);return this.then(function(e){clearTimeout(r),n.resolve(e)},function(e){clearTimeout(r),n.reject(e)},n.notify),n.promise},k.delay=function(e,t){return t===void 0&&(t=e,e=void 0),k(e).delay(t)},M.prototype.delay=function(e){return this.then(function(t){var n=L();return setTimeout(function(){n.resolve(t)},e),n.promise})},k.nfapply=function(e,t){return k(e).nfapply(t)},M.prototype.nfapply=function(e){var t=L(),n=a(e);return n.push(t.makeNodeResolver()),this.fapply(n).fail(t.reject),t.promise},k.nfcall=function(e){var t=a(arguments,1);return k(e).nfapply(t)},M.prototype.nfcall=function(){var e=a(arguments),t=L();return e.push(t.makeNodeResolver()),this.fapply(e).fail(t.reject),t.promise},k.nfbind=k.denodeify=function(e){var t=a(arguments,1);return function(){var n=t.concat(a(arguments)),r=L();return n.push(r.makeNodeResolver()),k(e).fapply(n).fail(r.reject),r.promise}},M.prototype.nfbind=M.prototype.denodeify=function(){var e=a(arguments);return e.unshift(this),k.denodeify.apply(void 0,e)},k.nbind=function(e,t){var n=a(arguments,2);return function(){function s(){return e.apply(t,arguments)}var r=n.concat(a(arguments)),i=L();return r.push(i.makeNodeResolver()),k(s).fapply(r).fail(i.reject),i.promise}},M.prototype.nbind=function(){var e=a(arguments,0);return e.unshift(this),k.nbind.apply(void 0,e)},k.nmapply=k.npost=function(e,t,n){return k(e).npost(t,n)},M.prototype.nmapply=M.prototype.npost=function(e,t){var n=a(t||[]),r=L();return n.push(r.makeNodeResolver()),this.dispatch("post",[e,n]).fail(r.reject),r.promise},k.nsend=k.nmcall=k.ninvoke=function(e,t){var n=a(arguments,2),r=L();return n.push(r.makeNodeResolver()),k(e).dispatch("post",[t,n]).fail(r.reject),r.promise},M.prototype.nsend=M.prototype.nmcall=M.prototype.ninvoke=function(e){var t=a(arguments,1),n=L();return t.push(n.makeNodeResolver()),this.dispatch("post",[e,t]).fail(n.reject),n.promise},k.nodeify=st,M.prototype.nodeify=function(e){if(!e)return this;this.then(function(t){s(function(){e(null,t)})},function(t){s(function(){e(t)})})};var ot=N();return k}),define("utils/FunctionUtils",[],function(){var e=function(){};return e.prototype.onCondition=function(t,n){t()?n():setTimeout(function(){e.prototype.onCondition(t,n)},50)},e.prototype.cron=function(e,t){var n=this;setTimeout(function(){n.cron(e,t),t()},e)},new e}),define("utils/Logger",[],function(){var e=function(e,t){this.name=e,t!==undefined&&(this.level=t)},t=function(e,t){var n=e+"";while(n.length<t)n="0"+n;return n},n=function(e){return e.level!==undefined?e.level:e.root.level},r=function(e,r,i){if(r.priority>=n(e).priority){var s=new Date,o=t(s.getHours(),2)+":"+t(s.getMinutes(),2)+":"+t(s.getSeconds(),2);o+=", "+e.name+", "+r.name+" : ",typeof i=="object"&&(i=JSON.stringify(i)),console.log(o+i)}},i=["DEBUG","INFO","WARN","ERROR"];for(var s=0;s<i.length;s++){var o=i[s],u={priority:s,name:o};e.prototype[o]=u,e[o]=u,e.prototype[o.toLowerCase()]=function(e){return function(t){r(this,e,t)}}(u)}return e.prototype.debug=function(t){r(this,e.DEBUG,t)},e.prototype.debug=function(t){r(this,e.DEBUG,t)},e.prototype.debug=function(t){r(this,e.DEBUG,t)},e.prototype.debug=function(t){r(this,e.DEBUG,t)},e.prototype.root=new e("ROOT",e.INFO),e}),define("db/IndexStorage",["q","underscore","utils/FunctionUtils","utils/Logger"],function(e,t,n,r){var i="$ALL",s=function(e){this.storage=e,f(this)},o=function(){var t=e.defer();return t.resolve(),t.promise},u=new r("IndexStorage",r.INFO),a=function(r){return t.size(r.buffer)==0?o():r.getAll().then(function(s){if(t.size(r.buffer)==0)return o();var a=e.defer();return n.onCondition(function(){var e=!1;return r.lock||(r.lock=!0,e=!0),e},function(){var e=s;e||(e={}),u.debug("adding buffer...");for(var t in r.buffer){var n=r.buffer[t];u.debug("adding key "+t+", value="+JSON.stringify(n)),e[t]=n}return u.debug("saving array="+JSON.stringify(e)),r.buffer={},r.storage.save(i,e).then(function(){r.lock=!1,a.resolve()})}),a.promise}).then(function(){return a(r)})};s.prototype.addIndexKey=function(e,t){return this.buffer[e]=t,a(this)},s.prototype.getAll=function(){return this.storage.get(i).then(function(e){return u.debug("result _all="+JSON.stringify(e)),e?e:{}})},s.prototype.waitIndex=function(){return a(this)};var f=function(e){e.buffer={},e.lock=!1};return s.prototype.destroy=function(){var e=this;return this.storage.del(i).then(function(){f(e)})},s}),define("db/StoragePlus",["q","utils/StringUtils","db/IndexStorage","underscore","utils/Logger"],function(e,t,n,r,i){var s=function(e,t,r){this.name=e,this.storage=t,r||(this.indexStorage=new n(new s("$$index$$"+e,this.storage,!0)))},o=new i("StoragePlus"),u=function(e){return e.name+"/"},a=function(e,t){return u(e)+t};return s.prototype.save=function(e,t){var n=this;o.debug("saving key "+e);var r=a(this,e);return this.indexStorage&&this.indexStorage.addIndexKey(e,t).fail(function(t){o.error("impossible to add index "+e+" on "+n.name),o.error(t)}),this.storage.save(r,t)},s.prototype.get=function(e){return this.storage.get(a(this,e))},s.prototype.del=function(e){return this.storage.del(a(this,e))},s.prototype.query=function(t){if(!this.indexStorage)throw"not supported : this is an index storage";if(!t.mapFunction)throw"mapFunction must be defined in the query";if(!t.indexDef)throw"indexDef must be defined in the query";var n=this,i={},s=0,o=0,u=function(e,n){if(t.startkey&&e<t.startkey||t.endkey&&e>t.endkey)return;var u=i[e];u||(u=[],i[e]=u,o++),u.push(r.extend({},n)),s++};return n.indexStorage.waitIndex().then(function(){return n.indexStorage.getAll()}).then(function(a){var f=r.map(a,function(e,r){return n.get(r).then(function(e){e&&t.mapFunction(u,e)})});return e.all(f).then(function(){return{total_keys:o,total_rows:s,rows:i}})})},s.prototype.getAll=function(){return this.query({mapFunction:function(e,t){e(t._id,t)},indexDef:"_id"})},s.prototype.waitIndex=function(){if(this.indexStorage)return o.info("wait for index on "+this.name),this.indexStorage.waitIndex();throw"this code should not be called !"},s.prototype.destroy=function(){if(!this.indexStorage){var t=e.defer();return t.resolve(),t.promise}var n=this;return n.waitIndex().then(function(){return n.indexStorage.getAll()}).then(function(t){return o.debug("destroy result="),o.debug(t),e.all(r.map(t,function(e,t){return o.debug("deleting "+t),n.del(t)}))}).then(function(){return n.indexStorage?n.indexStorage.destroy():!0})},s}),define("browserStorage/InMemoryStorage",["q","underscore","utils/Logger"],function(e,t,n){var r=function(){},i=new n("InMemoryStorage"),s=function(){return e.fcall(function(){})};return r.prototype.init=s,r.prototype.waitIndex=s,r.prototype.save=function(t,n){var r=e.defer();return this[t]=JSON.stringify(n),r.resolve(n),r.promise},r.prototype.get=function(t){var n=e.defer(),r=this[t],i=r?JSON.parse(r):null;return n.resolve(i),n.promise},r.prototype.del=function(t){var n=e.defer(),r=this[t]?!0:!1;return delete this[t],n.resolve(r),n.promise},r.prototype.destroy=function(){var n=e.defer();return t.each(this,function(e,t){i.debug("delete "+t),delete this[t]}),n.resolve(),n.promise},r.prototype.query=function(n){var r=this;return e.fcall(function(){var e={};e.rows=[],t.each(r,function(r,i){var s=JSON.parse(r),o=t.every(n.filters,function(e){var t=e.toFunction()(s);return t});o&&e.rows.push(s)}),e.total_rows=t.size(e.rows),e.total_keys=t.size(e.rows);var i=n.sorts&&n.sorts.length>0?n.sorts[0].keyName:null;return e.rows=t.groupBy(e.rows,function(e,t){return i?e[i]:t}),e})},r.prototype.isAdvanced=function(){return!0},r.prototype.create=function(e){return new r},r}),define("Random",[],function(){var e=function(){};return e.prototype.nextNumber=function(e,t){e||(e=0),t||(t=1);if(e>t)throw"min > max !";return Math.random()*(t-e)+e},e.prototype.nextInt=function(e,t){return Math.floor(this.nextNumber(e,t+1))},e.prototype.alphaDic="0987654321POIUYTREZAMLKJHGFDSQNBVCXWpoiuytrezamlkjhgfdsqnbvcxw",e.prototype.nextAlpha=function(e){e||(e=1);var t="";for(var n=0;n<e;n++)t+=this.alphaDic.charAt(this.nextInt(0,this.alphaDic.length-1));return t},e}),define("query/Query",[],function(){var e=function(e,t,n){this.filters=t?t:[],this.sorts=n?n:[]};return e}),define("query/Filter",[],function(){var e=function(e,t,n,r,i){this.keyName=e,this.lowBound=t,this.highBound=n,this.lowInclusive=r?!0:!1,this.highInclusive=i?!0:!1},t=function(e){return e!==null&&e!==undefined},n=function(e,n,r){return t(e)?r&&n?function(t){return e<=t}:r&&!n?function(t){return e<t}:!r&&n?function(t){return t<=e}:function(t){return t<e}:function(e){return!0}};return e.prototype.toFunction=function(){var e=this,t=n(e.lowBound,e.lowInclusive,!0),r=n(e.highBound,e.highInclusive,!1);return function(n){var i=n[e.keyName];return t(i)&&r(i)}},e.prototype.toStringFunction=function(){var e=this,t=n(e.lowBound,e.lowInclusive,!0),r=n(e.highBound,e.highInclusive,!1);return(fonction+"").replace("fonctionLow")},e}),define("db/FacadeStorage",["q","underscore","utils/Logger"],function(e,t,n){var r=function(e,t){this.impls=e,this.config=t},i=new n("FacadeBridge",n.INFO);return r.prototype.init=function(){var n=this,r=t.map(n.impls,function(e){return e.className});return i.info("looking for implementation in "+r),e.all(t.map(n.impls,function(t){var r=e.defer(),t=new t(n.config);return t.isSupported?t.isSupported().then(function(e){r.resolve(e)}):(i.warn("isSupported method not implemented in "+t),r.resolve(!1)),r.promise})).then(function(e){var r=-1,s=t.find(e,function(e){return r++,e?!0:!1});if(s)return n.implClasse=n.impls[r],i.info("class "+n.implClasse.className+" will be used"),n.impl=new n.implClasse(n.config),i.debug(n.impl),n.impl.init();throw"no implementation found"})},r.prototype.exists=function(){return this.impl.exists()},r.prototype.create=function(e){var n=t.omit(this.config,"name");return n.name=e,new r(this.impls,n)},r.prototype.isSupported=function(){var t=this;return e.fcall(function(){return t.impl!=undefined})},r.prototype.save=function(e,t){return this.impl.save(e,t)},r.prototype.get=function(e){return this.impl.get(e)},r.prototype.del=function(e){return this.impl.del(e)},r.prototype.destroy=function(){return this.impl.destroy()},r.prototype.query=function(e){return this.impl.query(e)},r.prototype.isAdvanced=function(){var e=this.impl;return e.isAdvanced&&e.isAdvanced()},r.prototype.waitIndex=function(){return this.impl.waitIndex?(i.debug("call waitIndex impl"),this.impl.waitIndex()):(i.debug("call waitIndex empty"),e.fcall(function(){}))},r}),define("utils/SimpleAjax",["q"],function(e){function n(){var e=null;if(!window.XMLHttpRequest&&!window.ActiveXObject)return alert("Votre navigateur ne supporte pas l'objet XMLHTTPRequest..."),null;if(window.ActiveXObject)try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){e=new ActiveXObject("Microsoft.XMLHTTP")}else e=new XMLHttpRequest;return e}var t=function(e,t,n){this.method=e.toUpperCase(),this.url=t;if(!this.url)throw"url should be defined";this.data=n};return t.prototype.call=function(){var t=new e.defer,r=this,i=n();return i.onreadystatechange=function(){i.readyState==4&&(i.status<400?t.resolve({data:i.responseText,statusCode:i.status}):t.reject({statusCode:i.status,error:i.responseText}))},i.open(r.method,r.url,!0),r.data!==undefined?i.send(r.data):i.send(),t.promise},t}),define("utils/Lock",["q","utils/FunctionUtils","utils/Logger"],function(e,t,n){var r=function(e){this.resources=1,e&&(this.resources=e)},i=new n("Lock",n.INFO),s=function(e){return e.then?!0:!1};return r.prototype.synchronize=function(){var n=e.defer(),r=this;return i.debug("enter synchronize"),t.onCondition(function(){var e=!1;return i.debug("check condition : "+r.resources),r.resources>=1&&(i.debug("taking lock"),r.resources--,i.debug("resources : "+r.resources),e=!0),e},function(){i.debug("resolving promise"),n.resolve()}),n.promise},r.prototype.release=function(){var t=this;return i.debug("release call"),e.fcall(function(){t.resources+=1,i.debug("releasing lock : "+t.resources)})},r.locks={},r.get=function(e,t){var n=r.locks[e];return n||(n=new r(t),r.locks[e]=n),n},r}),define("bridge/CouchDBBridge",["utils/SimpleAjax","utils/Logger","utils/Lock","q","underscore","utils/StringUtils","Random"],function(e,t,n,r,i,s,o){var u=function(e){var t=this;this.host=e.host,this.name=e.name,this.url=this.host+"/"+this.name+"/"};u.className="CouchDB";var a=new t("CouchDBBridge",t.INFO);u.prototype.exists=function(){var t=r.defer();return(new e("get",this.url)).call().then(function(e){a.info("exists ok"),t.resolve(e.statusCode==200)}).fail(function(e){a.info("exists false"),t.resolve(!1)}),t.promise},u.prototype.initDb=function(){var t=this,n=r.defer();return(new e("put",t.url)).call().then(function(){a.info("creating database "+t.url),n.resolve(!0)}).fail(function(e){e.statusCode!=412?(a.error("error when creating database "+t.url),n.reject(e)):(a.warn(t.url+" already exists"),n.resolve(e))}),n.promise},u.prototype.init=function(){return this.initDb()},u.prototype.isSupported=function(){return(new e("get",this.host)).call().then(function(e){try{var t=JSON.parse(e.data);return t.couchdb?!0:!1}catch(n){return!1}}).fail(function(){return!1})};var f=function(e){var t=e.toLowerCase();while(t.replace("/","$")!=t)t=t.replace("/","$");return t},l="couchFix",c=function(e,t,n){var r=i.extend({},e);return i.each(r,function(e,i){s.startsWith(i,t)&&(delete r[i],i=n+i.substring(t.length),r[i]=e)}),r},h=function(e){return c(e,"_",l)},p=function(e){return c(i.omit(e,"_id","_rev"),l,"_")},d=function(t,n){var i=r.defer();return(new e("get",t.url+f(n))).call().then(function(e){if(e&&e.data){var t=JSON.parse(e.data);i.resolve(t)}else i.reject(e)}).fail(function(e){e.statusCode==404?i.resolve(null):(a.error("error when getting couch object : "+JSON.stringify(e)),i.reject(e))}),i.promise};u.prototype.save=function(t,r){a.debug("saving key "+t);var i=this,s=n.get("CouchDBBridge/"+t);return s.synchronize().then(function(){return d(i,t)}).then(function(n){var s=h(r);return n&&n._rev&&(s._rev=n._rev),s._id=t,a.debug("saving at key "+t+" : "+JSON.stringify(s)),(new e("put",i.url+f(t),JSON.stringify(s))).call()}).then(function(){return s.release().then(function(){return r})})},u.prototype.get=function(e){var t=this;return d(t,e).then(function(e){return e?p(e):e})},u.prototype.del=function(t){var n=this,i=r.defer();return d(n,t).then(function(r){r&&r._rev?(new e("delete",n.url+f(t)+"?rev="+r._rev)).call().then(function(){i.resolve(!0)}).fail(function(e){i.reject(e)}):i.reject("result object should have a _rev field : "+JSON.stringify(r))}).fail(function(){i.reject("fail to retrieve object from key : "+t)}),i.promise},u.prototype.destroy=function(){var t=this;return(new e("delete",t.url)).call().then(function(e){a.info("destroying database "+t.url),a.debug(e)})};var v=function(e){return e!==null&&e!==undefined},m=function(e){var t=function(e){var t=e;return typeof e=="string"&&(t='"'+t+'"'),t},n=function(e,t,n){var r="&& ("+e+"<";return r+=n?"=":"",r+=t+")",r},r="",i=e.keyName;return i.substring(0,1)=="_"&&(i=l+i.substring(1)),r+="var value = doc."+i+";\n",r+="flag &= (true ",v(e.lowBound)&&(r+=n(t(e.lowBound),"value",e.lowInclusive)),v(e.highBound)&&(r+=n("value",t(e.highBound),e.highInclusive)),r+=");\n",r};return u.prototype.query=function(t){var n="_id";if(t.sorts&&t.sorts.length>0){if(t.sorts.length>1)throw"only 1 sort at the same time is supported";n=t.sorts[0].keyName}var s=this,u="function (doc) {\n";u+="var flag = true;\n",i.each(t.filters,function(e){u+=m(e)}),u+="if (flag) {emit(doc."+n+", doc);}}";var f=(new o).nextAlpha(20),l={_id:"_design/"+f,views:{viewName:{map:u}}},c,h=r.fcall(function(){});return h.then(function(){return a.debug("creating view:"+JSON.stringify(l)),(new e("put",s.url+l._id,JSON.stringify(l))).call()}).then(function(n){a.debug("result view:"+JSON.stringify(n));var r=JSON.parse(n.data);c=r.rev;var o=i.omit(t,"mapFunction");return(new e("get",s.url+l._id+"/_view/viewName",o)).call().then(function(e){var n=JSON.parse(e.data),r=0,s=i.groupBy(n.rows,function(e){return r++,e.key}),o={};i.each(s,function(e,t){o[t]=i.map(e,function(e){return p(e.value)})});var e={total_rows:r,total_keys:i.size(o),rows:o};return a.debug("result query "+JSON.stringify(t)+" : "),a.debug(e),e})}).then(function(t){return a.debug("deleting view:"+JSON.stringify(l)),a.debug("tempRev="+c),(new e("delete",s.url+l._id+"?rev="+c)).call().then(function(){return t})})},u.prototype.isAdvanced=function(){return!0},u}),define("bridge/RemoteFacadeBridge",["utils/Logger","db/FacadeStorage","bridge/CouchDBBridge"],function(e,t,n){var r=function(e){this.config=e,this.impls=[n]},i=r,s=new e("RemoteFacadeBridge");return r.prototype=new t,r.prototype.constructor=i,r}),define("SyncStorage",["utils/StringUtils","underscore","q","db/StoragePlus","browserStorage/InMemoryStorage","Random","utils/Logger","query/Query","query/Filter","bridge/RemoteFacadeBridge"],function(e,t,n,r,i,s,o,u,a,f){var l=function(e,t){return t.isAdvanced&&t.isAdvanced()?t.create(e):new r(e,t)},c=function(e,t){var n=this;this.name=e,t||(t=new i),this.simpleStorage=t,this.onConflict=function(e,t){h.error("Conflict detected on "+n.name+". This method should be overriden. doc1 and doc2 in conflicts :"),h.error(e),h.error(t)}};c.prototype.init=function(){var e=this;return e.simpleStorage.init().then(function(){var t="version$$"+e.name;return e.storage=l(e.name,e.simpleStorage),e.storageVersion=l(t,e.simpleStorage),n.all([e.storage.init(),e.storageVersion.init()])})};var h=new o("SyncStorage");c.prototype.random=new s;var p=function(e){var t=e.split("-");return{version:t[0],hash:t[1]}},d=function(e){if(!e._id)throw JSON.stringify(e)+" should have an _id field";var t=e._id;return e._rev&&(t+="/"+e._rev),t},v=function(e,t){return e.storageVersion.save(d(t),t).fail(function(e){h.error("error when saving in version storage : "+JSON.stringify(t)),h.error("error: "+JSON.stringify(e))})},m=function(e,t){var r=p(t._rev),i=r.version;return e.get({_id:t._id}).then(function(s){var o=[],u=!s;if(!u){var a=p(s._rev);u=a.version<i||a.version===i&&a.hash<r.hash;if(a.version>=i){var f=e.onConflict(s,t);if(!f){var l=u?s:t;l._conflict=!0;var c={_id:l._id,_rev:l._rev};console.warn(JSON.stringify(c)+" marked as conflicted on "+e.name);if(l==s){s._timestamp=(new Date).getTime(),delete s._synced;var d=v(e,s);o.push(d)}}else{var m=function(t){t._timestamp=(new Date).getTime(),delete t._synced,delete t._conflict;var n=v(e,t);o.push(n)};h.info("conflict solved with onConflict function : "+JSON.stringify(f)),m(s),m(t),o.push(e.save(f))}}}var d=v(e,t);return o.push(d),u&&(h.info("store object on "+e.name+" : "+JSON.stringify(t)),o.push(e.storage.save(t._id,t))),n.all(o).then(function(){return t})})};c.prototype.save=function(e){var n=this,r=t.extend({},e),i=(new Date).getTime();r._id||(r._id=i+n.random.nextAlpha(10));var s=1;if(r._rev){var s=p(r._rev).version;s++}return r._rev=s+"-"+n.random.nextAlpha(30),r._timestamp=i,delete r._synced,delete r._conflict,m(n,r)},c.prototype.get=function(e){var t=e._rev?this.storageVersion:this.storage;return t.get(d(e)).then(function(e){return e?(delete e._synced,e):e})},c.prototype.del=function(e){var t=e._rev?this.storageVersion:this.storage;return t.del(d(e))},c.prototype.query=function(e){return h.info("query="+JSON.stringify(e)),this.storage.query(e).then(function(e){return h.info("result query="+JSON.stringify(e)),e})},c.prototype.queryHistory=function(e){return h.info("query history="+JSON.stringify(e)),this.storageVersion.query(e).then(function(e){return h.info("result query history="+JSON.stringify(e)),e})};var g=function(e,r){var i="$repTo$"+r.name,s;return e.storage.get(i).then(function(t){var n=t?t._timestamp:undefined;return s=(new Date).getTime(),h.info("start replicating from "+e.name+" to "+r.name+". startTimestamp="+n+", endTimestamp="+s),e.storageVersion.waitIndex().then(function(){var t=new a("_timestamp",n,s,!0,!0),r=new u(null,[t],null);return e.storageVersion.query(r)})}).then(function(e){if(e.total_rows===0)return 0;h.debug(JSON.stringify(e,null,2));var i=[];for(var s in e.rows)t.each(e.rows[s],function(e){if(e._synced)return;var t=e;t._synced=!0,i.push(m(r,t))});return n.all(i).then(function(e){return e.length})}).then(function(e){var t={ok:!0,size:e};return t}).then(function(t){return e.storage.save(i,{_timestamp:s}).then(function(){return h.info("rep "+e.name+" to "+r.name+" ended : "+JSON.stringify(t)),t})}).fail(function(t){return h.error("rep "+e.name+" to "+r.name+" ended with error : "+JSON.stringify(t)),{error:!0,message:"Something went bad when updating objects"}})};return c.prototype.syncWith=function(e){var t=this;return g(t,e).then(function(n){return g(e,t).then(function(e){return{to:n,from:e}})})},c.prototype.waitIndex=function(){return this.storage.waitIndex()},c.prototype.destroy=function(){var e=this;return e.storage.waitIndex().then(function(){return e.storageVersion.waitIndex()}).then(function(){return n.all([e.storage.destroy(),e.storageVersion.destroy()])})},c});