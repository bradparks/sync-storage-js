define("utils/StringUtils",[],function(){var e=function(){};return e.prototype.startsWith=function(e,t){return e.substring(0,t.length)==t},new e}),define("utils/FunctionUtils",[],function(){var e=function(){};return e.prototype.onCondition=function(t,n){t()?n():setTimeout(function(){e.prototype.onCondition(t,n)},50)},e.prototype.cron=function(e,t){var n=this;setTimeout(function(){n.cron(e,t),t()},e)},new e}),define("db/IndexStorage",["q","underscore","utils/FunctionUtils"],function(e,t,n){var r=function(e){this.storage=e,o(this)},i=function(){var t=e.defer();return t.resolve(),t.promise},s=function(e){return t.size(e.buffer)==0?i():e.getAll().then(function(r){if(t.size(e.buffer)==0)return i();n.onCondition(function(){var t=!1;return e.lock||(e.lock=!0,t=!0),t},function(){var t=r;t||(t={}),console.log("adding buffer...");for(var n in e.buffer){var i=e.buffer[n];t[n]=i}return e.buffer={},e.storage.save("_all",t).then(function(){e.lock=!1})})}).then(function(){return s(e)})};r.prototype.addIndexKey=function(e,t){return this.buffer[e]=t,s(this)},r.prototype.getAll=function(){return this.storage.get("_all").then(function(e){return e?e:{}})},r.prototype.waitIndex=function(){return s(this)};var o=function(e){e.buffer={},e.lock=!1};return r.prototype.destroy=function(){var e=this;return this.storage.del("_all").then(function(){o(e)})},r}),define("db/StoragePlus",["q","utils/StringUtils","db/IndexStorage","underscore"],function(e,t,n,r){var i=function(e,t,r){this.name=e,this.storage=t,r||(this.indexStorage=new n(new i("__index__"+e,this.storage,!0)))},s=function(e){return e.name+"/"},o=function(e,t){return s(e)+t};return i.prototype.save=function(e,t){var n=o(this,e);return this.indexStorage&&this.indexStorage.addIndexKey(e,t),this.storage.save(n,t)},i.prototype.get=function(e){return this.storage.get(o(this,e))},i.prototype.del=function(e){return this.storage.del(o(this,e))},i.prototype.query=function(t){if(!this.indexStorage)throw"not supported : this is an index storage";if(!t.mapFunction)throw"mapFunction must be defined in the query";if(!t.indexDef)throw"indexDef must be defined in the query";var n=this,i={},s=0,o=0,u=function(e,n){if(t.startkey&&e<t.startkey||t.endkey&&e>t.endkey)return;var u=i[e];u||(u=[],i[e]=u,o++),u.push(r.extend({},n)),s++};return this.indexStorage.getAll().then(function(a){var f=r.map(a,function(e,r){return n.get(r).then(function(e){e&&t.mapFunction(u,e)})});return e.all(f).then(function(){return{total_keys:o,total_rows:s,rows:i}})})},i.prototype.getAll=function(){return this.query({mapFunction:function(e,t){e(t._id,t)},indexDef:"_id"})},i.prototype.waitIndex=function(){if(this.indexStorage)return this.indexStorage.waitIndex();var t=e.defer();return t.resolve(),t.promise},i.prototype.destroy=function(){if(!this.indexStorage){var t=e.defer();return t.resolve(),t.promise}var n=this;return n.waitIndex().then(function(){return n.indexStorage.getAll()}).then(function(t){return console.log("result="),console.log(t),e.all(r.map(t,function(e,t){return console.log("deleting "+t),n.del(t)}))}).then(function(){return n.indexStorage?n.indexStorage.destroy():!0})},i}),define("basicStorage/InMemoryStorage",["q","underscore"],function(e,t){var n=function(){};return n.prototype.save=function(t,n){var r=e.defer();return this[t]=JSON.stringify(n),r.resolve(n),r.promise},n.prototype.get=function(t){var n=e.defer(),r=this[t],i=r?JSON.parse(r):null;return n.resolve(i),n.promise},n.prototype.del=function(t){var n=e.defer(),r=this[t]?!0:!1;return delete this[t],n.resolve(r),n.promise},n.prototype.destroy=function(){var n=e.defer();return t.each(this,function(e,t){console.log("delete "+t),delete this[t]}),n.resolve(),n.promise},n}),define("Random",[],function(){var e=function(){};return e.prototype.nextNumber=function(e,t){e||(e=0),t||(t=1);if(e>t)throw"min > max !";return Math.random()*(t-e)+e},e.prototype.nextInt=function(e,t){return Math.floor(this.nextNumber(e,t+1))},e.prototype.alphaDic="0987654321POIUYTREZAMLKJHGFDSQNBVCXWpoiuytrezamlkjhgfdsqnbvcxw",e.prototype.nextAlpha=function(e){e||(e=1);var t="";for(var n=0;n<e;n++)t+=this.alphaDic.charAt(this.nextInt(0,this.alphaDic.length-1));return t},e}),define("SyncStorage",["utils/StringUtils","underscore","q","db/StoragePlus","basicStorage/InMemoryStorage","Random"],function(e,t,n,r,i,s){var o=function(t,n){var s=this;this.name=t,this.isLocal=!e.startsWith(t,"http"),n||(n=new i),this.storage=new r(t,n),this.storageVersion=new r("version$$"+t,n),this.onConflict=function(e,t){console.error("Conflict detected on "+s.name+". This method should be overriden. doc1 and doc2 in conflicts :"),console.error(e),console.error(t)}};o.prototype.random=new s;var u=function(e){var t=e.split("-");return{version:t[0],hash:t[1]}},a=function(e){if(!e._id)throw JSON.stringify(e)+" should have an _id field";var t=e._id;return e._rev&&(t+="/"+e._rev),t},f=function(e,t){var r=u(t._rev),i=r.version;return e.get({_id:t._id}).then(function(s){var o=[],f=!s;if(!f){var l=u(s._rev);f=l.version<i||l.version===i&&l.hash<r.hash;if(l.version>=i){var c=e.onConflict(s,t);if(!c){var h=f?s:t;h._conflict=!0;var p={_id:h._id,_rev:h._rev};console.warn(JSON.stringify(p)+" marked as conflicted on "+e.name),h==s&&(s._timestamp=(new Date).getTime(),delete s._synced,e.storageVersion.save(a(s),s))}else{var d=function(t){t._timstamp=(new Date).getTime(),delete t._synced,delete t._conflict,e.storageVersion.save(a(t),t)};console.log("conflict solved with onConflict function : "+JSON.stringify(c)),d(s),d(t),o.push(e.save(c))}}}return e.storageVersion.save(a(t),t),f&&(console.log("store object on "+e.name+" : "+JSON.stringify(t)),o.push(e.storage.save(t._id,t))),n.all(o).then(function(){return t})})};o.prototype.save=function(e){var n=this,r=t.extend({},e),i=(new Date).getTime();r._id||(r._id=i+n.random.nextAlpha(10));var s=1;if(r._rev){var s=u(r._rev).version;s++}return r._rev=s+"-"+n.random.nextAlpha(30),r._timestamp=i,delete r._synced,delete r._conflict,f(n,r)},o.prototype.get=function(e){var t=e._rev?this.storageVersion:this.storage;return t.get(a(e)).then(function(e){return e?(delete e._synced,e):e})},o.prototype.del=function(e){var t=e._rev?this.storageVersion:this.storage;return t.del(a(e))},o.prototype.query=function(e){return console.log("query="+JSON.stringify(e)),this.storage.query(e).then(function(e){return console.log("result query="+JSON.stringify(e)),e})},o.prototype.queryHistory=function(e){return console.log("query history="+JSON.stringify(e)),this.storageVersion.query(e).then(function(e){return console.log("result query history="+JSON.stringify(e)),e})};var l=function(e,r){var i="$repTo$"+r.name,s;return e.storage.get(i).then(function(t){var n=t?t._timestamp:undefined;return s=(new Date).getTime(),console.log("start replicating from "+e.name+" to "+r.name+". startTimestamp="+n+", endTimestamp="+s),e.storageVersion.query({mapFunction:function(e,t){t._synced||e(t._timestamp,t)},startkey:n,endkey:s,indexDef:"_timestamp"})}).then(function(e){if(e.total_rows===0)return 0;var i=[];for(var s in e.rows)t.each(e.rows[s],function(e){var t=e;t._synced=!0,i.push(f(r,t))});return n.all(i).then(function(e){return e.length})}).then(function(e){var t={ok:!0,size:e};return t}).then(function(t){return e.storage.save(i,{_timestamp:s}).then(function(){return console.log("rep "+e.name+" to "+r.name+" ended : "+JSON.stringify(t)),t})}).fail(function(t){return console.log("rep "+e.name+" to "+r.name+" ended : "+JSON.stringify(t)),{error:!0,message:"Something went bad when updating objects"}})};return o.prototype.syncWith=function(e){var t=this;return l(t,e).then(function(n){return l(e,t).then(function(e){return{to:n,from:e}})})},o.prototype.waitIndex=function(){return this.storage.waitIndex()},o.prototype.destroy=function(){var e=this;return n.all([e.storage.destroy(),e.storageVersion.destroy()])},o});